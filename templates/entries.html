{% extends "layout.html" %}

{% block title %}My Entries - LifeLog{% endblock %}

{% block content %}
<div class="entries-content">
    <div class="section-header">
        <h1>My Diary Entries</h1>
        <div class="header-actions">
            <a href="{{ url_for('diary') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Entry
            </a>
            <button id="delete-selected" class="btn btn-danger" style="display: none;">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>
    
    <div class="entries-layout">
        <!-- Calendar sidebar -->
        <div class="calendar-sidebar">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prev-month" class="calendar-nav"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="calendar-month">Month Year</h3>
                    <button id="next-month" class="calendar-nav"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-weekdays">
                    <div>Su</div>
                    <div>Mo</div>
                    <div>Tu</div>
                    <div>We</div>
                    <div>Th</div>
                    <div>Fr</div>
                    <div>Sa</div>
                </div>
                <div class="calendar-days" id="calendar-days">
                    <!-- Calendar days will be generated by JavaScript -->
                </div>
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-dot has-entries"></span>
                        <span>Has entries</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot selected"></span>
                        <span>Selected date</span>
                    </div>
                </div>
            </div>
            
            <!-- Additional filters -->
            <div class="sidebar-filters">
                <div class="filter-group">
                    <label for="mood-filter">Mood:</label>
                    <select id="mood-filter">
                        <option value="all">All Moods</option>
                        <option value="positive">Positive</option>
                        <option value="neutral">Neutral</option>
                        <option value="negative">Negative</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="sort-entries">Sort by:</label>
                    <select id="sort-entries">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>
                
                <button class="btn btn-secondary" onclick="resetFilters()">
                    <i class="fas fa-undo"></i> Reset Filters
                </button>
            </div>
        </div>
        
        <!-- Entries list -->
        <div class="entries-main">
            <div class="entries-header">
                <div class="entries-header-left">
                    <h2 id="entries-date-header">All Entries</h2>
                    <div class="entries-count" id="entries-count">Showing all entries</div>
                </div>
                <div class="entries-header-right">
                    <label class="select-all-container">
                        <input type="checkbox" id="select-all-entries">
                        <span>Select All</span>
                    </label>
                </div>
            </div>
            
            <form id="delete-entries-form" action="{{ url_for('delete_multiple_entries') }}" method="POST">
                <div class="entries-list" id="entries-container">
                    {% if entries %}
                        {% for entry in entries %}
                            <div class="entry-card" data-mood="{{ entry.mood|lower }}" data-date="{{ entry.date }}">
                                <div class="entry-checkbox">
                                    <input type="checkbox" name="entry_ids[]" value="{{ entry.id }}" class="entry-select">
                                </div>
                                <div class="entry-header">
                                    <div class="entry-mood {{ entry.mood|lower }}">
                                        <i class="fas fa-{{ 'smile' if entry.mood == 'Positive' else 'meh' if entry.mood == 'Neutral' else 'frown' }}"></i>
                                        <span>{{ entry.mood }}</span>
                                    </div>
                                    <div class="entry-date">{{ entry.date|datetime('%B %d, %Y') }}</div>
                                </div>
                                <div class="entry-preview">
                                    {{ entry.text[:150] + '...' if entry.text|length > 150 else entry.text }}
                                </div>
                                <div class="entry-footer">
                                    <div class="entry-actions">
                                        <a href="{{ url_for('view_entry', entry_id=entry.id) }}" class="btn btn-xs btn-secondary">View</a>
                                        <a href="{{ url_for('edit_entry', entry_id=entry.id) }}" class="btn btn-xs btn-primary">Edit</a>
                                        <a href="{{ url_for('delete_entry', entry_id=entry.id) }}" class="btn btn-xs btn-danger" onclick="return confirm('Are you sure you want to delete this entry?');">Delete</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-entries">
                            <p>You haven't written any entries yet.</p>
                            <a href="{{ url_for('diary') }}" class="btn btn-primary">Write your first entry</a>
                        </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get all entry cards and extract their dates
    const entryCards = Array.from(document.querySelectorAll('.entry-card'));
    const entryDates = new Set();
    entryCards.forEach(card => {
        entryDates.add(card.dataset.date);
    });
    
    // Calendar functionality
    const calendarDays = document.getElementById('calendar-days');
    const calendarMonth = document.getElementById('calendar-month');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const entriesContainer = document.getElementById('entries-container');
    const moodFilter = document.getElementById('mood-filter');
    const sortSelect = document.getElementById('sort-entries');
    const entriesDateHeader = document.getElementById('entries-date-header');
    const entriesCount = document.getElementById('entries-count');
    
    let currentDate = new Date();
    let selectedDate = null;
    
    // Initialize calendar
    function initCalendar() {
        renderCalendar(currentDate);
        
        // Add event listeners for month navigation
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
        
        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });
    }
    
    // Render calendar for a given month
    function renderCalendar(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        
        // Update calendar month/year display
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        calendarMonth.textContent = `${monthNames[month]} ${year}`;
        
        // Clear previous calendar days
        calendarDays.innerHTML = '';
        
        // Get first day of month and total days in month
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'empty');
            calendarDays.appendChild(emptyDay);
        }
        
        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.classList.add('calendar-day');
            dayElement.textContent = day;
            
            // Format date string to match entry data format (YYYY-MM-DD)
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayElement.dataset.date = dateStr;
            
            // Check if this date has entries
            if (entryDates.has(dateStr)) {
                dayElement.classList.add('has-entries');
            }
            
            // Check if this is the selected date
            if (selectedDate && dateStr === selectedDate) {
                dayElement.classList.add('selected');
            }
            
            // Add click event to filter entries by this date
            dayElement.addEventListener('click', () => {
                // Toggle selection if clicking the same date
                if (selectedDate === dateStr) {
                    selectedDate = null;
                    document.querySelectorAll('.calendar-day').forEach(day => {
                        day.classList.remove('selected');
                    });
                    entriesDateHeader.textContent = 'All Entries';
                } else {
                    selectedDate = dateStr;
                    document.querySelectorAll('.calendar-day').forEach(day => {
                        day.classList.remove('selected');
                    });
                    dayElement.classList.add('selected');
                    
                    // Format date for header
                    const selectedDateObj = new Date(selectedDate);
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    entriesDateHeader.textContent = selectedDateObj.toLocaleDateString('en-US', options);
                }
                
                // Apply filters
                applyFiltersAndSort();
            });
            
            calendarDays.appendChild(dayElement);
        }
    }
    
    // Apply filters and sorting
    function applyFiltersAndSort() {
        // Get filter values
        const selectedMood = moodFilter.value;
        const sortBy = sortSelect.value;
        
        // Filter entries
        let filteredEntries = entryCards.filter(card => {
            // Apply date filter if a date is selected
            if (selectedDate && card.dataset.date !== selectedDate) {
                return false;
            }
            
            // Apply mood filter
            if (selectedMood !== 'all' && !card.dataset.mood.includes(selectedMood)) {
                return false;
            }
            
            return true;
        });
        
        // Sort entries
        filteredEntries.sort((a, b) => {
            if (sortBy === 'newest') {
                // Sort by date (newest first)
                const dateA = new Date(a.dataset.date);
                const dateB = new Date(b.dataset.date);
                return dateB - dateA;
            } else if (sortBy === 'oldest') {
                // Sort by date (oldest first)
                const dateA = new Date(a.dataset.date);
                const dateB = new Date(b.dataset.date);
                return dateA - dateB;
            }
            return 0;
        });
        
        // Clear container
        entriesContainer.innerHTML = '';
        
        // Add filtered and sorted entries back to container
        if (filteredEntries.length > 0) {
            filteredEntries.forEach(card => {
                entriesContainer.appendChild(card.cloneNode(true));
            });
            
            // Update entries count
            entriesCount.textContent = `Showing ${filteredEntries.length} ${filteredEntries.length === 1 ? 'entry' : 'entries'}`;
        } else {
            // No entries match filters
            entriesContainer.innerHTML = `
                <div class="no-entries">
                    <p>No entries match your filters.</p>
                    <button class="btn btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> Reset Filters
                    </button>
                </div>
            `;
            entriesCount.textContent = 'No entries found';
        }
    }
    
    // Reset filters
    function resetFilters() {
        moodFilter.value = 'all';
        sortSelect.value = 'newest';
        selectedDate = null;
        
        // Remove selected class from all calendar days
        document.querySelectorAll('.calendar-day').forEach(day => {
            day.classList.remove('selected');
        });
        
        entriesDateHeader.textContent = 'All Entries';
        
        applyFiltersAndSort();
    }
    
    // Add event listeners
    moodFilter.addEventListener('change', applyFiltersAndSort);
    sortSelect.addEventListener('change', applyFiltersAndSort);
    
    // Initialize calendar and filters
    initCalendar();
    applyFiltersAndSort();
    
    // Add bulk delete functionality
    const selectAllCheckbox = document.getElementById('select-all-entries');
    const entryCheckboxes = document.querySelectorAll('.entry-select');
    const deleteSelectedBtn = document.getElementById('delete-selected');
    const deleteEntriesForm = document.getElementById('delete-entries-form');
    
    // Show/hide delete button based on selections
    function updateDeleteButton() {
        const checkedBoxes = document.querySelectorAll('.entry-select:checked');
        if (checkedBoxes.length > 0) {
            deleteSelectedBtn.style.display = 'inline-flex';
            deleteSelectedBtn.textContent = `Delete Selected (${checkedBoxes.length})`;
        } else {
            deleteSelectedBtn.style.display = 'none';
        }
    }
    
    // Select all entries
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            entryCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateDeleteButton();
        });
    }
    
    // Update delete button when individual checkboxes change
    entryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateDeleteButton);
    });
    
    // Handle delete button click
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.entry-select:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select at least one entry to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${checkedBoxes.length} selected entries? This action cannot be undone.`)) {
                deleteEntriesForm.submit();
            }
        });
    }
    
    // Initialize delete button state
    updateDeleteButton();
</script>
{% endblock %}




















